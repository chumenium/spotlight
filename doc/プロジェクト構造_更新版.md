# SpotLight プロジェクト構造（更新版）

## 📁 最新のディレクトリ構造

```
spotlight/
├── lib/                          # Flutterアプリ（フロントエンド）
│   ├── auth/                     # ✨ 認証関連（新規整理）
│   │   ├── auth_provider.dart        # 認証状態管理
│   │   ├── auth_service.dart         # 認証ユーティリティ
│   │   ├── auth_config.dart          # 認証設定（Twitter APIなど）
│   │   ├── social_login_screen.dart  # ソーシャルログイン画面
│   │   └── README.md                 # 認証機能ドキュメント
│   │
│   ├── config/                   # アプリ設定
│   │   ├── app_config.dart          # アプリ全体の設定
│   │   ├── firebase_config.dart     # Firebase設定
│   │   └── README.md
│   │
│   ├── models/                   # データモデル
│   │   ├── notification.dart
│   │   ├── post.dart
│   │   └── search_history.dart
│   │
│   ├── providers/                # 状態管理（Provider）
│   │   └── navigation_provider.dart  # ナビゲーション状態
│   │
│   ├── screens/                  # 画面
│   │   ├── home_screen.dart
│   │   ├── search_screen.dart
│   │   ├── create_post_screen.dart
│   │   ├── notifications_screen.dart
│   │   ├── profile_screen.dart
│   │   ├── history_list_screen.dart
│   │   ├── playlist_list_screen.dart
│   │   └── spotlight_list_screen.dart
│   │
│   ├── services/                 # サービス層
│   │   ├── firebase_service.dart    # Firebase初期化
│   │   └── README.md
│   │
│   ├── utils/                    # ユーティリティ
│   │   └── spotlight_colors.dart
│   │
│   ├── widgets/                  # 共通ウィジェット
│   │   └── bottom_navigation_bar.dart
│   │
│   └── main.dart                 # エントリーポイント
│
├── backend/                      # Pythonバックエンド（API サーバー）
│   ├── app.py                       # Flask アプリケーション
│   ├── config/
│   │   └── settings.py
│   ├── routes/                      # APIルート
│   │   ├── auth.py
│   │   ├── users.py
│   │   ├── posts.py
│   │   ├── comments.py
│   │   ├── notifications.py
│   │   └── search.py
│   ├── models/
│   ├── utils/
│   │   └── auth.py
│   └── requirements.txt
│
├── doc/                          # ドキュメント
│   ├── API仕様書.md
│   ├── プロジェクト構造.md
│   ├── 機能仕様書.md
│   ├── 開発ガイド.md
│   ├── アーキテクチャ設計.md
│   └── ソーシャル認証への移行.md
│
├── FIREBASE_QUICKSTART.md        # Firebase クイックスタート
├── SOCIAL_AUTH_GUIDE.md          # ソーシャルログイン設定ガイド
├── SECURITY_AND_CODE_IMPROVEMENT.md  # セキュリティ改善報告
├── pubspec.yaml                  # Flutter依存関係
└── README.md
```

---

## 🎯 Feature-First構造の採用

### 変更前（Layer-First）
```
lib/
├── providers/
│   ├── auth_provider.dart        # 認証
│   └── navigation_provider.dart  # ナビゲーション
├── services/
│   ├── auth_service.dart         # 認証
│   └── firebase_service.dart
├── config/
│   ├── auth_config.dart          # 認証
│   ├── firebase_config.dart
│   └── app_config.dart
└── screens/
    ├── social_login_screen.dart  # 認証
    └── ... 他の画面
```
**問題点**: 認証関連のファイルが複数のディレクトリに分散

### 変更後（Feature-First）✨
```
lib/
├── auth/                         # 👈 認証機能を1箇所に集約
│   ├── auth_provider.dart
│   ├── auth_service.dart
│   ├── auth_config.dart
│   ├── social_login_screen.dart
│   └── README.md
├── providers/
│   └── navigation_provider.dart
├── services/
│   └── firebase_service.dart
└── config/
    ├── firebase_config.dart
    └── app_config.dart
```
**メリット**:
- ✅ 認証関連のコードが1箇所に集約
- ✅ 機能単位での管理が容易
- ✅ 新しい開発者が理解しやすい
- ✅ 変更の影響範囲が明確

---

## 📂 `lib/auth/` ディレクトリ詳細

### ファイル一覧と役割

| ファイル | 役割 | 主な機能 |
|---------|------|---------|
| `auth_provider.dart` | 認証状態管理 | Google/Apple/Twitterログイン、ログアウト |
| `auth_service.dart` | 認証ユーティリティ | Firebase UID取得、エラーメッセージ変換 |
| `auth_config.dart` | 認証設定 | Twitter API Key、OAuth設定 |
| `social_login_screen.dart` | ログイン画面 | ソーシャルログインUI |
| `README.md` | ドキュメント | 認証機能の使い方、設計方針 |

### 依存関係

```
social_login_screen.dart
    ↓ import
auth_provider.dart
    ↓ import
auth_service.dart ← auth_config.dart
    ↓ import
Firebase Authentication SDK
```

---

## 🔄 インポートパスの変更

### main.dart
```dart
// 変更前
import 'providers/auth_provider.dart';
import 'screens/social_login_screen.dart';

// 変更後
import 'auth/auth_provider.dart';
import 'auth/social_login_screen.dart';
```

### auth_provider.dart
```dart
// 変更前
import '../config/auth_config.dart';
import '../services/auth_service.dart';

// 変更後
import 'auth_config.dart';
import 'auth_service.dart';
```

### social_login_screen.dart
```dart
// 変更前
import '../providers/auth_provider.dart';

// 変更後
import 'auth_provider.dart';
```

---

## 📊 レイヤー構造

```
┌─────────────────────────────────────────────┐
│  Presentation Layer (UI)                    │
│  - screens/                                 │
│  - auth/social_login_screen.dart            │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│  State Management Layer                     │
│  - providers/navigation_provider.dart       │
│  - auth/auth_provider.dart                  │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│  Business Logic Layer                       │
│  - services/firebase_service.dart           │
│  - auth/auth_service.dart                   │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│  Configuration Layer                        │
│  - config/app_config.dart                   │
│  - config/firebase_config.dart              │
│  - auth/auth_config.dart                    │
└─────────────────────────────────────────────┘
```

---

## 🎨 設計原則

### 1. Feature-First Organization
機能ごとにファイルをグループ化：
- **auth/** - 認証機能
- 今後追加予定:
  - **posts/** - 投稿機能
  - **search/** - 検索機能
  - **notifications/** - 通知機能

### 2. 単一責任の原則（SRP）
- `auth_provider.dart` - 認証状態管理のみ
- `auth_service.dart` - 認証ユーティリティのみ
- `auth_config.dart` - 認証設定のみ

### 3. 依存性逆転の原則（DIP）
```
UI → Provider → Service → Firebase SDK
```
上位レイヤーは下位レイヤーに依存するが、
下位レイヤーは上位レイヤーを知らない

---

## 🔐 セキュリティ設計

### 認証フロー

```
1. ユーザーがログインボタンをタップ
   ↓
2. social_login_screen.dart
   → auth_provider.loginWithGoogle()
   ↓
3. Google Sign-Inダイアログ
   ↓
4. Google認証情報取得
   ↓
5. Firebase Authenticationに送信
   ↓
6. Firebase UID自動生成
   ↓
7. authStateChangesリスナー発火
   ↓
8. auth_provider._onAuthStateChanged()
   ↓
9. User情報更新（id = Firebase UID）
   ↓
10. UI更新
```

### ユーザーID管理

```dart
// Firebase UIDをそのまま使用
User(
  id: firebaseUser.uid,  // 自動生成される一意のID
  email: firebaseUser.email,
  username: firebaseUser.displayName,
  avatarUrl: firebaseUser.photoURL,
);
```

**重要**: 
- ユーザーIDはFirebaseが自動生成
- メールアドレス・パスワードはソーシャルログインから自動取得
- ユーザーが手動で登録する項目はない

---

## 🚀 今後の拡張計画

### 追加予定のfeatureディレクトリ

```
lib/
├── auth/              ✅ 完成
├── posts/             📝 計画中
│   ├── post_provider.dart
│   ├── post_service.dart
│   ├── post_screen.dart
│   └── README.md
├── search/            📝 計画中
│   ├── search_provider.dart
│   ├── search_service.dart
│   ├── search_screen.dart
│   └── README.md
└── notifications/     📝 計画中
    ├── notification_provider.dart
    ├── notification_service.dart
    ├── notifications_screen.dart
    └── README.md
```

---

## 📚 ドキュメント一覧

### 認証関連
- **lib/auth/README.md** - 認証機能の詳細ドキュメント
- **SOCIAL_AUTH_GUIDE.md** - ソーシャルログイン設定ガイド
- **SECURITY_AND_CODE_IMPROVEMENT.md** - セキュリティ改善報告

### Firebase関連
- **FIREBASE_QUICKSTART.md** - Firebase クイックスタート
- **doc/アーキテクチャ設計.md** - アーキテクチャ全体の設計

### API関連
- **doc/API仕様書.md** - バックエンドAPI仕様
- **backend/SETUP_GUIDE.md** - バックエンド設定ガイド

---

## 💡 ベストプラクティス

### 1. 新しい機能の追加
```
1. lib/ 直下に feature ディレクトリを作成
2. provider、service、screen、config を配置
3. README.md で機能を説明
4. 他の機能への依存を最小限に
```

### 2. インポートパス
```dart
// 同じfeature内
import 'auth_service.dart';  // OK

// 別feature
import '../config/firebase_config.dart';  // OK

// 深いネスト避ける
import '../../features/auth/auth_provider.dart';  // NG
```

### 3. ファイル命名
```
- Provider: *_provider.dart
- Service: *_service.dart
- Screen: *_screen.dart
- Config: *_config.dart
- Model: *.dart (シンプル)
```

---

## ✅ リファクタリング完了項目

- [x] auth関連ファイルを`lib/auth/`に集約
- [x] インポートパスの修正
- [x] README.mdの作成
- [x] コメントの充実化
- [x] セキュリティの改善（Twitter API Key分離）
- [x] 不要なコード削除（メール/パスワード関連）
- [x] Firebase UID使用の明確化

---

## 📝 変更履歴

### 2025-10-21
- **Feature-First構造への移行**
  - `lib/auth/`ディレクトリを作成
  - 認証関連ファイルを集約
  - インポートパスを更新
  - ドキュメントを充実化

この構造により、コードの保守性と可読性が大幅に向上し、
新しい開発者でも認証機能の全体像を把握しやすくなりました。

